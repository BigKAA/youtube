---
# tasks file for k8s_anoter_master_setup
- name: Get certificate key
  shell: kubeadm init phase upload-certs --upload-certs
  register: certificate_key_raw
  delegate_to: "{{ groups['k8s_1st_master'][0] }}"
  run_once: True
  args:
    creates: .ansible_k8s/node_joined.txt

- name: get join command
  shell: kubeadm token create --print-join-command
  register: join_command_raw
  delegate_to: "{{ groups['k8s_1st_master'][0] }}"
  run_once: True
  args:
    creates: .ansible_k8s/node_joined.txt

- name: Start Kubelet service
  service:
    name: kubelet
    state: started
    enabled: yes

- name: Create hidden directory
  file:
    path: $HOME/.ansible_k8s
    state: directory
    owner: root
    group: root
    mode: 0755

- name: join cluster
  shell: "{{ join_command_raw.stdout_lines[0] }} --control-plane --certificate-key {{ certificate_key_raw.stdout_lines[2] }} >> .ansible_k8s/node_joined.txt"
  args:
    chdir: $HOME
    creates: .ansible_k8s/node_joined.txt
