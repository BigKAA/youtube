---
# tasks file for k8s_packages_install
- name: Disable firewalld
  service:
    name: firewalld
    state: stopped
    enabled: no

- name: Check is swap enable
  shell: swapon
  register: swap_present
  changed_when: false
  ignore_errors: true

- name: If swap is enabled - disable it
  shell: swapoff -a
  when: swap_present.stdout != ""

- name: Disable SWAP in fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].*\s*swap\s*.*)$'
    replace: '# \1'

- name: Disable SELinux
  selinux:
    state: disabled
  register: selinux_ret

- name: Reboot server after selinux policy changed
  shell: sleep 5 && reboot now
  async: 1
  poll: 0
  when: selinux_ret.reboot_required

- name: Wait untill server rebooted
  wait_for:
    host: "{{ inventory_hostname }}"
    state: started
    delay: 5
    timeout: 60
  delegate_to: 127.0.0.1
  when: selinux_ret.reboot_required

- name: Add the overlay module
  community.general.modprobe:
    name: overlay
    state: present

- name: Add the br_netfilter module
  community.general.modprobe:
    name: br_netfilter
    state: present

- name: Copy containerd.conf
  copy:
    src: containerd.conf
    dest: /etc/modules-load.d/containerd.conf
    owner: root
    group: root
    mode: u=rw,g=r,o=r

- name: Set some sysctl-settings
  sysctl:
    name: '{{ item.key }}'
    value: '{{ item.value }}'
    sysctl_file: /etc/sysctl.d/99-kubernetes-cri.conf
    sysctl_set: yes
    state: present
    reload: yes
  with_dict: '{{ k8s_packages_install_sysctl_config }}'

- name: Copy kubernetes.repo
  copy:
    src: kubernetes.repo
    dest: /etc/yum.repos.d/kubernetes.repo
    owner: root
    group: root
    mode: u=rw,g=r,o=r

- name: Install k8s programms
  dnf:
    name:
      - kubeadm-{{ k8s_packages_install_kuber_version }}.x86_64
      - kubelet-{{ k8s_packages_install_kuber_version }}.x86_64
    state: latest

