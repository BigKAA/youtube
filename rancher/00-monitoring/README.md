# Мониторинг в Rancher

В Rancher для организации мониторинга используется 
[Prometheus Operator](https://github.com/prometheus-operator/prometheus-operator).
Оператор позволяет устанавливать один или несколько prometheus с сопутствующими приложениями в кластере.
Поэтому, что бы научиться настраивать систему мониторинга в Rancher необходимо подробно изучить документацию.

Основой набор приложений: prometheus, alertmanager, grafana. Можно установить при помощи web интерфейса
rancher. Дополнительные инсталляции добавляются только при помощи манифестов.

## Установка основного набора приложений мониторинга.

Установить и управлять этими приложениями имеет право только администратор rancher или администратор 
соответствующего кластера.

Вы можете разрешить другим пользователям добавлять правила сбора метрик, добавление дополнительных dashboards
в grafana и конфигурацию alertmanager, при помощи добавления разрешения доступа к проекту в котором будет
установлен этот софт.

1. Выберите кластер в котором будет установлен мониторинг.
2. Создайте проект `Monitoring`.
3. В левом нижнем углу нажмите кнопку `Cluster Tools`.
4. В разделе `Monitoring` нажмите кнопку `Install`.

![pic1](images/pic1.png)

5. `Install into Project` -> `Monitoring`
6. Установите чекбокс `Customize Helm options befor install`. 
7. Нажмите кнопку `Next`. 
8. В секции `Prometheus` установите необходимые значения в полях ввода. 
9. Если для хранения метрик будут использовать PV, установите чекбокс `Persistent Sorage for Prometheus` и
   заполните необходимые поля.
10. Нажмите кнопку `Edit YAML`.

Если вы хотите разрешить добавлять dashboards в grafana из других namespaces, выполните следующий пункт.

11. Найдите ветку `grafana.sidecar.dashboards.searchNamespace` и в качестве значения поставьте `ALL`.

![pic2](images/pic2.png)

12. Если при установке системы не удаётся выделить PV, попробуйте удалить выделенные строки.

![pic3](images/pic3.png)

13. Нажмите кнопку `Next`.
14. Нажмите кнопку `Install` и дождитесь завершения установки.

В результате в проекте `Monitoring` будет создан namespace `cattle-monitoring-system` в котором будут запущены 
все приложения системы мониторинга.

Добавьте namespace `cattle-dashboards` в проект `Monitoring`.

![pic4](images/pic4.png)

## Тестовое приложение

Сначала средствами rancher создадим проект `Test-app`.

Добавим пользователя в Rancher. При добавлении пользователя выберем глобальную роль `User-Base`.
Этот пользователь предназначен для управления проектом `Test-app`.

В проекте `Test-app` в меню выберите `Edit Config`. В закладке `Members` добавьте пользователя с
ролью `Member`, нажмите кнопку `Save`.

В проекте `Monitoring` в меню выберите `Edit Config`. В закладке `Members` добавьте пользователя с
ролью `Read Only`, нажмите кнопку `Save`.

Выйдите из системы и зайдите новым пользователем. Выберите кластер, в котором вы 
будете работать.

Слева выберите раздел мониторинг.

В проекте `Test-app` создайте namespace `test-app`.

Запустим тестовое приложение.

```shell
kubectl -n test-app apply -f manifests/application.yaml
```

## Сбор метрик

Добавим target в текущий экземпляр Prometheus при помощи `ServiceMonitor`.

```shell
kubectl -n test-app apply -f manifests/service-monitor.yaml
```

Через некоторое время в списке targets Prometheus появится наше приложение.

## Grafana dashboard

Для того, что бы добавить кастомный дашборд в grafana необходимо каким либо образом получить его json файл.
Например, его можно сделать непосредственно в grafana. Логопас по умолчанию: `admin/prom-operator` 

Затем json помещают в ConfigMap. Пример можно посмотреть в файле 
[dashboard.yaml](manifests/dashboard.yaml).

Важно понимать, что в ConfigMap обязательно необходимо добавить "волшебную" метку:

```yaml
metadata:
  labels:
    grafana_dashboard: "1"
```
